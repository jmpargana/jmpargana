{"version":3,"file":"create-form.js","sources":["../../src/create-form.ts"],"sourcesContent":["import type {\n  Form,\n  FormConfig,\n  FormConfigWithTransformFn,\n  FormConfigWithoutTransformFn,\n  ExtenderHandler,\n  StoreFactory,\n  Obj,\n  ValidationFunction,\n  TransformFunction,\n  UnknownStores,\n  Stores,\n  KnownStores,\n  Helpers,\n  UnknownHelpers,\n  KnownHelpers,\n  ValidatorOptions,\n} from '@felte/common';\nimport { executeTransforms } from '@felte/common';\nimport { createHelpers } from './helpers';\nimport { createFormAction } from './create-form-action';\nimport type { FormActionConfig } from './create-form-action';\nimport { createStores } from './stores';\nimport { deepSetKey } from './deep-set-key';\n\nexport type Adapters<StoreExt = Record<string, any>> = {\n  storeFactory: StoreFactory<StoreExt>;\n};\n\nexport type CoreForm<Data extends Obj = any> = Form<Data> & {\n  cleanup(): void;\n  startStores(): () => void;\n};\n\nexport function createForm<\n  Data extends Obj = Obj,\n  Ext extends Obj = Obj,\n  StoreExt = Record<string, any>\n>(\n  config: FormConfigWithTransformFn<Data> & Ext,\n  adapters: Adapters<StoreExt>\n): CoreForm<Data> & UnknownHelpers<Data> & UnknownStores<Data, StoreExt>;\nexport function createForm<\n  Data extends Obj = Obj,\n  Ext extends Obj = Obj,\n  StoreExt = Record<string, any>\n>(\n  config: FormConfigWithoutTransformFn<Data> & Ext,\n  adapters: Adapters<StoreExt>\n): CoreForm<Data> & KnownHelpers<Data> & KnownStores<Data, StoreExt>;\nexport function createForm<\n  Data extends Obj = Obj,\n  Ext extends Obj = Obj,\n  StoreExt = Record<string, any>\n>(\n  config: FormConfig<Data> & Ext,\n  adapters: Adapters<StoreExt>\n): CoreForm<Data> & Helpers<Data> & Stores<Data, StoreExt>;\nexport function createForm<\n  Data extends Obj = Obj,\n  Ext extends Obj = Obj,\n  StoreExt = Record<string, any>\n>(\n  config: FormConfig<Data> & { preventStoreStart?: boolean } & Ext,\n  adapters: Adapters<StoreExt>\n): CoreForm<Data> & Helpers<Data> & Stores<Data, StoreExt> {\n  config.extend ??= [];\n  config.debounced ??= {};\n  if (config.validate && !Array.isArray(config.validate))\n    config.validate = [config.validate];\n\n  if (config.debounced.validate && !Array.isArray(config.debounced.validate))\n    config.debounced.validate = [config.debounced.validate];\n\n  if (config.transform && !Array.isArray(config.transform))\n    config.transform = [config.transform];\n\n  if (config.warn && !Array.isArray(config.warn)) config.warn = [config.warn];\n  if (config.debounced.warn && !Array.isArray(config.debounced.warn))\n    config.debounced.warn = [config.debounced.warn];\n\n  function addValidator(\n    validator: ValidationFunction<Data>,\n    { debounced, level }: ValidatorOptions = {\n      debounced: false,\n      level: 'error',\n    }\n  ) {\n    const prop = level === 'error' ? 'validate' : 'warn';\n    config.debounced ??= {};\n    const validateConfig = debounced ? config.debounced : config;\n    if (!validateConfig[prop]) {\n      validateConfig[prop] = [validator];\n    } else {\n      validateConfig[prop] = [\n        ...(validateConfig[prop] as ValidationFunction<Data>[]),\n        validator,\n      ];\n    }\n  }\n\n  function addTransformer(transformer: TransformFunction<Data>) {\n    if (!config.transform) {\n      (config as FormConfig<Data>).transform = [transformer];\n    } else {\n      config.transform = [\n        ...(config.transform as TransformFunction<Data>[]),\n        transformer,\n      ];\n    }\n  }\n\n  const extender = Array.isArray(config.extend)\n    ? config.extend\n    : [config.extend];\n\n  let currentExtenders: ExtenderHandler<Data>[] = [];\n  const {\n    isSubmitting,\n    isValidating,\n    data,\n    errors,\n    warnings,\n    touched,\n    isValid,\n    isDirty,\n    cleanup,\n    start,\n    validateErrors,\n    validateWarnings,\n    interacted,\n  } = createStores(adapters.storeFactory, config);\n  const originalUpdate = data.update;\n  const originalSet = data.set;\n\n  const transUpdate: typeof data.update = (updater) =>\n    originalUpdate((values) =>\n      deepSetKey(executeTransforms(updater(values), config.transform))\n    );\n  const transSet: typeof data.set = (values) =>\n    originalSet(deepSetKey(executeTransforms(values, config.transform)));\n\n  data.update = transUpdate;\n  data.set = transSet;\n\n  const helpers = createHelpers<Data>({\n    extender,\n    config,\n    addValidator,\n    addTransformer,\n    validateErrors,\n    validateWarnings,\n    stores: {\n      data,\n      errors,\n      warnings,\n      touched,\n      isValid,\n      isValidating,\n      isSubmitting,\n      isDirty,\n      interacted,\n    },\n  });\n\n  currentExtenders = extender.map((extender) =>\n    extender({\n      stage: 'SETUP',\n      errors,\n      warnings,\n      touched,\n      data,\n      config,\n      addValidator,\n      addTransformer,\n      setFields: helpers.public.setFields,\n      reset: helpers.public.reset,\n      validate: helpers.public.validate,\n    })\n  );\n\n  const _getCurrentExtenders = () => currentExtenders;\n  const _setCurrentExtenders = (extenders: ExtenderHandler<Data>[]) => {\n    currentExtenders = extenders;\n  };\n\n  const formActionConfig: FormActionConfig<Data> = {\n    config,\n    stores: {\n      data,\n      touched,\n      errors,\n      warnings,\n      isSubmitting,\n      isValidating,\n      isValid,\n      isDirty,\n      interacted,\n    },\n    helpers: {\n      ...helpers.public,\n      addTransformer,\n      addValidator,\n    },\n    extender,\n    validateErrors,\n    validateWarnings,\n    _getCurrentExtenders,\n    _setCurrentExtenders,\n    ...helpers.private,\n  };\n\n  const { form, createSubmitHandler, handleSubmit } = createFormAction<Data>(\n    formActionConfig\n  );\n\n  return {\n    data,\n    errors,\n    warnings,\n    touched,\n    isValid,\n    isSubmitting,\n    isValidating,\n    isDirty,\n    interacted,\n    form,\n    handleSubmit,\n    createSubmitHandler,\n    cleanup,\n    startStores: start,\n    ...helpers.public,\n  };\n}\n"],"names":[],"mappings":"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"}