{"version":3,"file":"helpers.js","sources":["../../src/helpers.ts"],"sourcesContent":["import type {\n  Errors,\n  Extender,\n  FieldValue,\n  FormConfig,\n  Obj,\n  Stores,\n  Touched,\n  ValidationFunction,\n  TransformFunction,\n  Setter,\n  ObjectSetter,\n  PartialErrorsSetter,\n  AssignableErrors,\n  PrimitiveSetter,\n  FieldsSetter,\n  Helpers,\n  Keyed,\n} from '@felte/common';\nimport {\n  deepSet,\n  setForm,\n  _cloneDeep,\n  _get,\n  _set,\n  _unset,\n  _update,\n  _isPlainObject,\n  createId,\n} from '@felte/common';\nimport { get } from './get';\nimport { deepSetTouched } from './deep-set-touched';\nimport { deepSetKey } from './deep-set-key';\n\ntype CreateHelpersOptions<Data extends Obj> = {\n  config: FormConfig<Data>;\n  stores: Stores<Data>;\n  validateErrors(data: Data | Keyed<Data>): Promise<Errors<Data> | undefined>;\n  validateWarnings(data: Data | Keyed<Data>): Promise<Errors<Data> | undefined>;\n  extender: Extender<Data>[];\n  addValidator(validator: ValidationFunction<Data>): void;\n  addTransformer(transformer: TransformFunction<Data>): void;\n};\n\nfunction addAtIndex<Data extends Obj>(\n  storeValue: Data,\n  path: string,\n  value: any,\n  index?: number\n) {\n  return _update(storeValue, path, (oldValue) => {\n    if (typeof oldValue !== 'undefined' && !Array.isArray(oldValue))\n      return oldValue;\n    if (!oldValue) oldValue = [];\n    if (typeof index === 'undefined') {\n      oldValue.push(value);\n    } else {\n      oldValue.splice(index, 0, value);\n    }\n    return oldValue;\n  });\n}\n\nfunction swapInArray<Data extends Obj>(\n  storeValue: Data,\n  path: string,\n  from: number,\n  to: number\n) {\n  return _update(storeValue, path, (oldValue) => {\n    if (!oldValue || !Array.isArray(oldValue)) return oldValue;\n    [oldValue[from], oldValue[to]] = [oldValue[to], oldValue[from]];\n    return oldValue;\n  });\n}\n\nfunction moveInArray<Data extends Obj>(\n  storeValue: Data,\n  path: string,\n  from: number,\n  to: number\n) {\n  return _update(storeValue, path, (oldValue) => {\n    if (!oldValue || !Array.isArray(oldValue)) return oldValue;\n    oldValue.splice(to, 0, oldValue.splice(from, 1)[0] as any);\n    return oldValue;\n  });\n}\n\nfunction isUpdater<T>(value: unknown): value is (value: T) => T {\n  return typeof value === 'function';\n}\n\nfunction createSetHelper<Data extends Obj, Path extends string>(\n  storeSetter: (\n    updater: (value: Errors<Data>) => AssignableErrors<Data>\n  ) => void\n): PartialErrorsSetter<Data, Path>;\nfunction createSetHelper<Data extends Obj, Path extends string>(\n  storeSetter: (updater: (value: Data) => Data) => void\n): ObjectSetter<Data, Path>;\nfunction createSetHelper<Data extends boolean | string | null>(\n  storeSetter: (updater: (value: Data) => Data) => void\n): PrimitiveSetter<Data>;\nfunction createSetHelper<Data extends Obj | boolean>(\n  storeSetter: (updater: (value: Data) => Data) => void\n): Setter<Data> {\n  const setHelper = (\n    pathOrValue: string | Data | ((value: Data) => Data),\n    valueOrUpdater?: unknown | ((value: unknown) => unknown)\n  ) => {\n    if (typeof pathOrValue === 'string') {\n      const path = pathOrValue;\n      storeSetter((oldValue) => {\n        const newValue = isUpdater(valueOrUpdater)\n          ? (valueOrUpdater(_get(oldValue as Obj, path)) as Data)\n          : valueOrUpdater;\n        return _set(\n          oldValue as Obj,\n          path,\n          newValue as FieldValue | FieldValue[]\n        ) as Data;\n      });\n    } else {\n      storeSetter((oldValue) =>\n        isUpdater<Data>(pathOrValue) ? pathOrValue(oldValue) : pathOrValue\n      );\n    }\n  };\n\n  return setHelper as Setter<Data>;\n}\n\nexport function createHelpers<Data extends Obj>({\n  stores,\n  config,\n  validateErrors,\n  validateWarnings,\n}: CreateHelpersOptions<Data>) {\n  let formNode: HTMLFormElement | undefined;\n  let initialValues = deepSetKey((config.initialValues ?? {}) as Data);\n\n  const {\n    data,\n    touched,\n    errors,\n    warnings,\n    isDirty,\n    isSubmitting,\n    interacted,\n  } = stores;\n\n  const setData = createSetHelper<Data, string>(data.update);\n\n  const setTouched = createSetHelper<Touched<Data>, string>(touched.update);\n\n  const setErrors = createSetHelper<Data, string>(errors.update);\n\n  const setWarnings = createSetHelper<Data, string>(warnings.update);\n\n  function updateFields(updater: (values: Data) => Data) {\n    setData((oldData) => {\n      const newData = updater(oldData);\n      if (formNode) setForm(formNode, newData);\n      return newData;\n    });\n  }\n\n  const setFields: FieldsSetter<Data, string> = (\n    pathOrValue: string | Data | ((value: Data) => Data),\n    valueOrUpdater?: unknown | ((value: unknown) => unknown),\n    shouldTouch?: boolean\n  ) => {\n    const fieldsSetter = createSetHelper<Data, string>(updateFields);\n    fieldsSetter(pathOrValue as any, valueOrUpdater as any);\n    if (typeof pathOrValue === 'string' && shouldTouch) {\n      setTouched<string, any>(pathOrValue, true);\n    }\n  };\n\n  function addField(path: string, value: unknown, index?: number) {\n    const touchedValue = _isPlainObject(value)\n      ? deepSetTouched(value, false)\n      : false;\n    const errValue = _isPlainObject(touchedValue)\n      ? deepSet(touchedValue, [])\n      : [];\n    value = _isPlainObject(value) ? { ...value, key: createId() } : value;\n    errors.update(($errors) => {\n      return addAtIndex($errors, path, errValue, index);\n    });\n    warnings.update(($warnings) => {\n      return addAtIndex($warnings, path, errValue, index);\n    });\n    touched.update(($touched) => {\n      return addAtIndex($touched, path, touchedValue, index);\n    });\n    data.update(($data) => {\n      const newData = addAtIndex($data, path, value, index);\n      setTimeout(() => formNode && setForm(formNode, newData));\n      return newData;\n    });\n  }\n\n  function updateAll(updater: <Data extends Obj>(storeValue: Data) => Data) {\n    errors.update(updater);\n    warnings.update(updater);\n    touched.update(updater);\n    data.update(($data) => {\n      const newData = updater($data);\n      setTimeout(() => formNode && setForm(formNode, newData));\n      return newData;\n    });\n  }\n\n  function unsetField(path: string) {\n    updateAll((storeValue) => _unset(storeValue, path));\n  }\n\n  function swapFields(path: string, from: number, to: number) {\n    updateAll((storeValue) => swapInArray(storeValue, path, from, to));\n  }\n\n  function moveField(path: string, from: number, to: number) {\n    updateAll((storeValue) => moveInArray(storeValue, path, from, to));\n  }\n\n  function resetField(path: string) {\n    const initialValue = _get(initialValues, path);\n    const touchedValue: any = _isPlainObject(initialValue)\n      ? deepSetTouched(initialValue as Obj, false)\n      : false;\n    const errValue: any = _isPlainObject(touchedValue)\n      ? deepSet(touchedValue, [])\n      : [];\n    data.update(($data) => {\n      const newData = _set($data, path, initialValue);\n      if (formNode) setForm(formNode, newData);\n      return newData;\n    });\n    touched.update(($touched) => {\n      return _set($touched, path, touchedValue);\n    });\n    errors.update(($errors) => {\n      return _set($errors, path, errValue);\n    });\n    warnings.update(($warnings) => {\n      return _set($warnings, path, errValue);\n    });\n  }\n\n  const setIsSubmitting = createSetHelper(isSubmitting.update);\n\n  const setIsDirty = createSetHelper(isDirty.update);\n\n  const setInteracted = createSetHelper(interacted.update);\n\n  async function validate(): Promise<Errors<Data> | void> {\n    const currentData = get(data);\n    touched.set(deepSetTouched(currentData, true));\n    interacted.set(null);\n    const currentErrors = await validateErrors(currentData);\n    await validateWarnings(currentData);\n    return currentErrors;\n  }\n\n  function reset(): void {\n    setFields(_cloneDeep(initialValues));\n    setTouched(($touched) => deepSet($touched, false) as Touched<Data>);\n    interacted.set(null);\n    isDirty.set(false);\n  }\n\n  const publicHelpers: Helpers<Data> = {\n    setData,\n    setFields,\n    setTouched,\n    setErrors,\n    setWarnings,\n    setIsSubmitting,\n    setIsDirty,\n    setInteracted,\n    validate,\n    reset,\n    unsetField,\n    resetField,\n    addField,\n    swapFields,\n    moveField,\n    setInitialValues: (values: Data) => {\n      initialValues = deepSetKey(values);\n    },\n  };\n\n  const privateHelpers = {\n    _setFormNode(node: HTMLFormElement) {\n      formNode = node;\n    },\n    _getFormNode: () => formNode,\n    _getInitialValues: () => initialValues,\n  };\n\n  return {\n    public: publicHelpers,\n    private: privateHelpers,\n  };\n}\n"],"names":[],"mappings":"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"}