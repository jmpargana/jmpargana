{"version":3,"file":"stores.js","sources":["../../src/stores.ts"],"sourcesContent":["import type {\n  StoreFactory,\n  Obj,\n  Keyed,\n  FormConfig,\n  Errors,\n  Touched,\n  ValidationFunction,\n  PartialWritableErrors,\n  AssignableErrors,\n  KeyedWritable,\n} from '@felte/common';\nimport type { Writable, Readable, Unsubscriber } from 'svelte/store';\nimport {\n  _cloneDeep,\n  deepSet,\n  _isPlainObject,\n  _mergeWith,\n  runValidations,\n  mergeErrors,\n  executeTransforms,\n  deepSome,\n  debounce,\n} from '@felte/common';\nimport { deepSetTouched } from './deep-set-touched';\nimport { deepRemoveKey, deepSetKey } from './deep-set-key';\n\ntype ValidationController = {\n  signal: {\n    readonly aborted: boolean;\n    readonly priority: boolean;\n  };\n  abort(): void;\n};\n\nfunction createValidationController(priority: boolean): ValidationController {\n  const signal = { aborted: false, priority };\n  return {\n    signal,\n    abort() {\n      signal.aborted = true;\n    },\n  };\n}\n\nexport function errorFilterer(touchValue?: unknown, errValue?: unknown) {\n  if (_isPlainObject(touchValue)) {\n    if (\n      !errValue ||\n      (_isPlainObject(errValue) && Object.keys(errValue).length === 0)\n    ) {\n      return deepSet(touchValue, null);\n    }\n    return;\n  }\n  if (Array.isArray(touchValue)) {\n    if (touchValue.some(_isPlainObject)) return;\n    const errArray = Array.isArray(errValue) ? errValue : [];\n    return touchValue.map((value, index) => {\n      const err = errArray[index];\n      if (Array.isArray(err) && err.length === 0) return null;\n      return (value && err) || null;\n    });\n  }\n  if (Array.isArray(errValue) && errValue.length === 0) return null;\n  if (Array.isArray(errValue)) return touchValue ? errValue : null;\n  return touchValue && errValue ? [errValue] : null;\n}\n\nexport function warningFilterer(touchValue?: unknown, errValue?: unknown) {\n  if (_isPlainObject(touchValue)) {\n    if (\n      !errValue ||\n      (_isPlainObject(errValue) && Object.keys(errValue).length === 0)\n    ) {\n      return deepSet(touchValue, null);\n    }\n    return;\n  }\n  if (Array.isArray(touchValue)) {\n    if (touchValue.some(_isPlainObject)) return;\n    const errArray = Array.isArray(errValue) ? errValue : [];\n    return touchValue.map((_, index) => {\n      const err = errArray[index];\n      if (Array.isArray(err) && err.length === 0) return null;\n      return err || null;\n    });\n  }\n  if (Array.isArray(errValue) && errValue.length === 0) return null;\n  if (Array.isArray(errValue)) return errValue;\n  return errValue ? [errValue] : null;\n}\n\nfunction filterErrors<Data extends Obj>([errors, touched]: [\n  Errors<Data>,\n  Touched<Data>\n]) {\n  return _mergeWith<Errors<Data>>(touched, errors, errorFilterer);\n}\n\nfunction filterWarnings<Data extends Obj>([errors, touched]: [\n  Errors<Data>,\n  Touched<Data>\n]) {\n  return _mergeWith<Errors<Data>>(touched, errors, warningFilterer);\n}\n\ntype Readables =\n  | Readable<any>\n  | [Readable<any>, ...Array<Readable<any>>]\n  | Array<Readable<any>>;\n\ntype ReadableValues<T> = T extends Readable<infer U>\n  ? [U]\n  : { [K in keyof T]: T[K] extends Readable<infer U> ? U : never };\n\ntype PossibleWritable<T> = Readable<T> & {\n  update?: (updater: (v: T) => T) => void;\n  set?: (v: T) => void;\n};\n\n// A `derived` store factory that can defer subscription and be constructed\n// with any store factory.\nexport function createDerivedFactory<StoreExt = Record<string, any>>(\n  storeFactory: StoreFactory<StoreExt>\n) {\n  return function derived<R, T extends Readables = Readables>(\n    storeOrStores: T,\n    deriver: (values: ReadableValues<T>) => R,\n    initialValue: R\n  ): [PossibleWritable<R> & StoreExt, () => void, () => void] {\n    const stores: Readable<any>[] = Array.isArray(storeOrStores)\n      ? storeOrStores\n      : [storeOrStores];\n    const values: any[] = new Array(stores.length);\n    const derivedStore: PossibleWritable<R> & StoreExt = storeFactory(\n      initialValue\n    );\n\n    const storeSet = derivedStore.set as Writable<R>['set'];\n    const storeSubscribe = derivedStore.subscribe;\n    let unsubscribers: Unsubscriber[] | undefined;\n\n    function startStore() {\n      unsubscribers = stores.map((store, index) => {\n        return store.subscribe(($store: any) => {\n          values[index] = $store;\n          storeSet(deriver(values as ReadableValues<T>));\n        });\n      });\n    }\n\n    function stopStore() {\n      unsubscribers?.forEach((unsub) => unsub());\n    }\n\n    derivedStore.subscribe = function subscribe(\n      subscriber: (value: R) => void\n    ) {\n      const unsubscribe = storeSubscribe(subscriber);\n      return () => {\n        unsubscribe();\n      };\n    };\n\n    return [derivedStore, startStore, stopStore];\n  };\n}\n\nexport function createStores<Data extends Obj, StoreExt = Record<string, any>>(\n  storeFactory: StoreFactory<StoreExt>,\n  config: FormConfig<Data> & { preventStoreStart?: boolean }\n) {\n  const derived = createDerivedFactory(storeFactory);\n  const initialValues = (config.initialValues = config.initialValues\n    ? deepSetKey(\n        executeTransforms(\n          _cloneDeep(config.initialValues as Data),\n          config.transform\n        )\n      )\n    : ({} as Data));\n  const initialTouched = deepSetTouched(deepRemoveKey(initialValues), false);\n  const touched = storeFactory(initialTouched);\n\n  const validationCount = storeFactory(0);\n  const [isValidating, startIsValidating, stopIsValidating] = derived(\n    [touched, validationCount],\n    ([$touched, $validationCount]) => {\n      const isTouched = deepSome($touched as Obj, (t) => !!t);\n      return isTouched && $validationCount >= 1;\n    },\n    false\n  );\n\n  // It is important not to destructure stores created with the factory\n  // since some stores may be callable.\n  delete isValidating.set;\n  delete isValidating.update;\n\n  function cancellableValidation<Data extends Obj>(\n    store: PartialWritableErrors<Data>\n  ) {\n    let activeController: ValidationController | undefined;\n    return async function executeValidations(\n      $data: Data,\n      shape: Errors<Data>,\n      validations?: ValidationFunction<Data>[] | ValidationFunction<Data>,\n      priority = false\n    ) {\n      if (!validations || !$data) return;\n      let current =\n        shape && Object.keys(shape).length > 0\n          ? shape\n          : (deepSet($data, []) as Errors<Data>);\n\n      // Keeping a controller allows us to cancel previous asynchronous\n      // validations if they've become stale.\n      const controller = createValidationController(priority);\n\n      // By assigning `priority` we can prevent specific validations\n      // from being aborted. Used when submitting the form or\n      // calling the `validate` helper.\n      if (!activeController?.signal.priority || priority) {\n        activeController?.abort();\n        activeController = controller;\n      }\n\n      // If the current controller has priority and we're not trying to\n      // override it, completely prevent validations\n      if (activeController.signal.priority && !priority) return;\n      validationCount.update((c) => c + 1);\n      const results = runValidations($data, validations);\n      results.forEach(async (promise: any) => {\n        const result = await promise;\n        if (controller.signal.aborted) return;\n        current = mergeErrors([current, result]);\n        store.set(current);\n      });\n      await Promise.all(results);\n      activeController = undefined;\n      validationCount.update((c) => c - 1);\n      return current;\n    };\n  }\n\n  let storesShape = deepSet(initialTouched, []) as Errors<Data>;\n  const data = storeFactory(initialValues);\n\n  const initialErrors = deepSet(initialTouched, []) as Errors<Data>;\n  const immediateErrors = storeFactory(\n    initialErrors\n  ) as PartialWritableErrors<Data> & StoreExt;\n  const debouncedErrors = storeFactory(\n    _cloneDeep(initialErrors)\n  ) as PartialWritableErrors<Data> & StoreExt;\n  const [errors, startErrors, stopErrors] = derived<Errors<Data>>(\n    [\n      immediateErrors as Readable<Errors<Data>>,\n      debouncedErrors as Readable<Errors<Data>>,\n    ],\n    mergeErrors,\n    _cloneDeep(initialErrors)\n  );\n\n  const initialWarnings = deepSet(initialTouched, []) as Errors<Data>;\n  const immediateWarnings = storeFactory(\n    initialWarnings\n  ) as PartialWritableErrors<Data> & StoreExt;\n  const debouncedWarnings = storeFactory(\n    _cloneDeep(initialWarnings)\n  ) as PartialWritableErrors<Data> & StoreExt;\n  const [warnings, startWarnings, stopWarnings] = derived<Errors<Data>>(\n    [\n      immediateWarnings as Readable<Errors<Data>>,\n      debouncedWarnings as Readable<Errors<Data>>,\n    ],\n    mergeErrors,\n    _cloneDeep(initialWarnings)\n  );\n\n  const [filteredErrors, startFilteredErrors, stopFilteredErrors] = derived(\n    [errors as Readable<Errors<Data>>, touched as Readable<Touched<Data>>],\n    filterErrors,\n    _cloneDeep(initialErrors)\n  );\n\n  const [\n    filteredWarnings,\n    startFilteredWarnings,\n    stopFilteredWarnings,\n  ] = derived(\n    [warnings as Readable<Errors<Data>>, touched as Readable<Touched<Data>>],\n    filterWarnings,\n    _cloneDeep(initialWarnings)\n  );\n\n  // This is necessary since, on the first run, validations\n  // have not run yet. We assume the form is not valid in the first calling\n  // if there's validation functions assigned in the configuration.\n  let firstCalled = false;\n  const [isValid, startIsValid, stopIsValid] = derived(\n    errors,\n    ([$errors]) => {\n      if (!firstCalled) {\n        firstCalled = true;\n        return !config.validate && !config.debounced?.validate;\n      } else {\n        return !deepSome($errors, (error) =>\n          Array.isArray(error) ? error.length >= 1 : !!error\n        );\n      }\n    },\n    !config.validate && !config.debounced?.validate\n  );\n\n  delete isValid.set;\n  delete isValid.update;\n\n  const isSubmitting = storeFactory(false);\n\n  const isDirty = storeFactory(false);\n\n  const interacted = storeFactory<string | null>(null);\n\n  const validateErrors = cancellableValidation(immediateErrors);\n  const validateWarnings = cancellableValidation(immediateWarnings);\n  const validateDebouncedErrors = cancellableValidation(debouncedErrors);\n  const validateDebouncedWarnings = cancellableValidation(debouncedWarnings);\n  const _validateDebouncedErrors = debounce(\n    validateDebouncedErrors,\n    config.debounced?.validateTimeout ?? config.debounced?.timeout ?? 300\n  );\n  const _validateDebouncedWarnings = debounce(\n    validateDebouncedWarnings,\n    config.debounced?.warnTimeout ?? config.debounced?.timeout ?? 300\n  );\n\n  async function executeErrorsValidation(\n    data: Data | Keyed<Data>,\n    altValidate?: ValidationFunction<Data> | ValidationFunction<Data>[]\n  ): Promise<Errors<Data> | undefined> {\n    const $data = deepRemoveKey(data);\n    const errors = validateErrors(\n      $data,\n      storesShape,\n      altValidate ?? config.validate,\n      true\n    );\n    if (altValidate) return errors;\n    const debouncedErrors = validateDebouncedErrors(\n      $data,\n      storesShape,\n      config.debounced?.validate,\n      true\n    );\n    return mergeErrors<Errors<Data>>(\n      await Promise.all([errors, debouncedErrors])\n    );\n  }\n\n  async function executeWarningsValidation(\n    data: Data | Keyed<Data>,\n    altWarn?: ValidationFunction<Data> | ValidationFunction<Data>[]\n  ): Promise<Errors<Data> | undefined> {\n    const $data = deepRemoveKey(data);\n    const warnings = validateWarnings(\n      $data,\n      storesShape,\n      altWarn ?? config.warn,\n      true\n    );\n    if (altWarn) return warnings;\n    const debouncedWarnings = validateDebouncedWarnings(\n      $data,\n      storesShape,\n      config.debounced?.warn,\n      true\n    );\n    return mergeErrors<Errors<Data>>(\n      await Promise.all([warnings, debouncedWarnings])\n    );\n  }\n\n  let errorsValue = initialErrors;\n  let warningsValue = initialWarnings;\n  function start() {\n    const dataUnsubscriber = data.subscribe(($keyedData) => {\n      const $data = deepRemoveKey($keyedData);\n      validateErrors($data, storesShape, config.validate);\n      validateWarnings($data, storesShape, config.warn);\n      _validateDebouncedErrors($data, storesShape, config.debounced?.validate);\n      _validateDebouncedWarnings($data, storesShape, config.debounced?.warn);\n    });\n\n    const unsubscribeTouched = touched.subscribe(($touched) => {\n      storesShape = deepSet($touched, []) as Errors<Data>;\n    });\n    const unsubscribeErrors = errors.subscribe(($errors) => {\n      errorsValue = $errors;\n    });\n    const unsubscribeWarnings = warnings.subscribe(($warnings) => {\n      warningsValue = $warnings;\n    });\n\n    startErrors();\n    startIsValid();\n    startWarnings();\n    startFilteredErrors();\n    startFilteredWarnings();\n    startIsValidating();\n\n    function cleanup() {\n      dataUnsubscriber();\n      stopFilteredErrors();\n      stopErrors();\n      stopWarnings();\n      stopFilteredWarnings();\n      stopIsValid();\n      stopIsValidating();\n      unsubscribeTouched();\n      unsubscribeErrors();\n      unsubscribeWarnings();\n    }\n    return cleanup;\n  }\n\n  function publicErrorsUpdater(\n    updater: (value: Errors<Data>) => AssignableErrors<Data>\n  ): void {\n    immediateErrors.set(updater(errorsValue));\n    debouncedErrors.set({} as AssignableErrors<Data>);\n  }\n\n  function publicWarningsUpdater(\n    updater: (value: Errors<Data>) => AssignableErrors<Data>\n  ): void {\n    immediateWarnings.set(updater(warningsValue));\n    debouncedWarnings.set({} as AssignableErrors<Data>);\n  }\n\n  function publicErrorsSetter(value: AssignableErrors<Data>): void {\n    publicErrorsUpdater(() => value);\n  }\n\n  function publicWarningsSetter(value: AssignableErrors<Data>): void {\n    publicWarningsUpdater(() => value);\n  }\n\n  filteredErrors.set = publicErrorsSetter;\n  (filteredErrors as PartialWritableErrors<Data>).update = publicErrorsUpdater;\n  filteredWarnings.set = publicWarningsSetter;\n  (filteredWarnings as PartialWritableErrors<Data>).update = publicWarningsUpdater;\n\n  return {\n    data: data as KeyedWritable<Data> & StoreExt,\n    errors: filteredErrors as PartialWritableErrors<Data> & StoreExt,\n    warnings: filteredWarnings as PartialWritableErrors<Data> & StoreExt,\n    touched,\n    isValid,\n    isSubmitting,\n    isDirty,\n    isValidating,\n    interacted,\n    validateErrors: executeErrorsValidation,\n    validateWarnings: executeWarningsValidation,\n    cleanup: config.preventStoreStart ? () => undefined : start(),\n    start,\n  };\n}\n"],"names":[],"mappings":";;;;AAmCA,SAAS,0BAA0B,CAAC,QAAiB;IACnD,MAAM,MAAM,GAAG,EAAE,OAAO,EAAE,KAAK,EAAE,QAAQ,EAAE,CAAC;IAC5C,OAAO;QACL,MAAM;QACN,KAAK;YACH,MAAM,CAAC,OAAO,GAAG,IAAI,CAAC;SACvB;KACF,CAAC;AACJ,CAAC;SAEe,aAAa,CAAC,UAAoB,EAAE,QAAkB;IACpE,IAAI,cAAc,CAAC,UAAU,CAAC,EAAE;QAC9B,IACE,CAAC,QAAQ;aACR,cAAc,CAAC,QAAQ,CAAC,IAAI,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,MAAM,KAAK,CAAC,CAAC,EAChE;YACA,OAAO,OAAO,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;SAClC;QACD,OAAO;KACR;IACD,IAAI,KAAK,CAAC,OAAO,CAAC,UAAU,CAAC,EAAE;QAC7B,IAAI,UAAU,CAAC,IAAI,CAAC,cAAc,CAAC;YAAE,OAAO;QAC5C,MAAM,QAAQ,GAAG,KAAK,CAAC,OAAO,CAAC,QAAQ,CAAC,GAAG,QAAQ,GAAG,EAAE,CAAC;QACzD,OAAO,UAAU,CAAC,GAAG,CAAC,CAAC,KAAK,EAAE,KAAK;YACjC,MAAM,GAAG,GAAG,QAAQ,CAAC,KAAK,CAAC,CAAC;YAC5B,IAAI,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,GAAG,CAAC,MAAM,KAAK,CAAC;gBAAE,OAAO,IAAI,CAAC;YACxD,OAAO,CAAC,KAAK,IAAI,GAAG,KAAK,IAAI,CAAC;SAC/B,CAAC,CAAC;KACJ;IACD,IAAI,KAAK,CAAC,OAAO,CAAC,QAAQ,CAAC,IAAI,QAAQ,CAAC,MAAM,KAAK,CAAC;QAAE,OAAO,IAAI,CAAC;IAClE,IAAI,KAAK,CAAC,OAAO,CAAC,QAAQ,CAAC;QAAE,OAAO,UAAU,GAAG,QAAQ,GAAG,IAAI,CAAC;IACjE,OAAO,UAAU,IAAI,QAAQ,GAAG,CAAC,QAAQ,CAAC,GAAG,IAAI,CAAC;AACpD,CAAC;SAEe,eAAe,CAAC,UAAoB,EAAE,QAAkB;IACtE,IAAI,cAAc,CAAC,UAAU,CAAC,EAAE;QAC9B,IACE,CAAC,QAAQ;aACR,cAAc,CAAC,QAAQ,CAAC,IAAI,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,MAAM,KAAK,CAAC,CAAC,EAChE;YACA,OAAO,OAAO,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;SAClC;QACD,OAAO;KACR;IACD,IAAI,KAAK,CAAC,OAAO,CAAC,UAAU,CAAC,EAAE;QAC7B,IAAI,UAAU,CAAC,IAAI,CAAC,cAAc,CAAC;YAAE,OAAO;QAC5C,MAAM,QAAQ,GAAG,KAAK,CAAC,OAAO,CAAC,QAAQ,CAAC,GAAG,QAAQ,GAAG,EAAE,CAAC;QACzD,OAAO,UAAU,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,KAAK;YAC7B,MAAM,GAAG,GAAG,QAAQ,CAAC,KAAK,CAAC,CAAC;YAC5B,IAAI,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,GAAG,CAAC,MAAM,KAAK,CAAC;gBAAE,OAAO,IAAI,CAAC;YACxD,OAAO,GAAG,IAAI,IAAI,CAAC;SACpB,CAAC,CAAC;KACJ;IACD,IAAI,KAAK,CAAC,OAAO,CAAC,QAAQ,CAAC,IAAI,QAAQ,CAAC,MAAM,KAAK,CAAC;QAAE,OAAO,IAAI,CAAC;IAClE,IAAI,KAAK,CAAC,OAAO,CAAC,QAAQ,CAAC;QAAE,OAAO,QAAQ,CAAC;IAC7C,OAAO,QAAQ,GAAG,CAAC,QAAQ,CAAC,GAAG,IAAI,CAAC;AACtC,CAAC;AAED,SAAS,YAAY,CAAmB,CAAC,MAAM,EAAE,OAAO,CAGvD;IACC,OAAO,UAAU,CAAe,OAAO,EAAE,MAAM,EAAE,aAAa,CAAC,CAAC;AAClE,CAAC;AAED,SAAS,cAAc,CAAmB,CAAC,MAAM,EAAE,OAAO,CAGzD;IACC,OAAO,UAAU,CAAe,OAAO,EAAE,MAAM,EAAE,eAAe,CAAC,CAAC;AACpE,CAAC;AAgBD;AACA;SACgB,oBAAoB,CAClC,YAAoC;IAEpC,OAAO,SAAS,OAAO,CACrB,aAAgB,EAChB,OAAyC,EACzC,YAAe;QAEf,MAAM,MAAM,GAAoB,KAAK,CAAC,OAAO,CAAC,aAAa,CAAC;cACxD,aAAa;cACb,CAAC,aAAa,CAAC,CAAC;QACpB,MAAM,MAAM,GAAU,IAAI,KAAK,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;QAC/C,MAAM,YAAY,GAAmC,YAAY,CAC/D,YAAY,CACb,CAAC;QAEF,MAAM,QAAQ,GAAG,YAAY,CAAC,GAAyB,CAAC;QACxD,MAAM,cAAc,GAAG,YAAY,CAAC,SAAS,CAAC;QAC9C,IAAI,aAAyC,CAAC;QAE9C,SAAS,UAAU;YACjB,aAAa,GAAG,MAAM,CAAC,GAAG,CAAC,CAAC,KAAK,EAAE,KAAK;gBACtC,OAAO,KAAK,CAAC,SAAS,CAAC,CAAC,MAAW;oBACjC,MAAM,CAAC,KAAK,CAAC,GAAG,MAAM,CAAC;oBACvB,QAAQ,CAAC,OAAO,CAAC,MAA2B,CAAC,CAAC,CAAC;iBAChD,CAAC,CAAC;aACJ,CAAC,CAAC;SACJ;QAED,SAAS,SAAS;YAChB,aAAa,aAAb,aAAa,uBAAb,aAAa,CAAE,OAAO,CAAC,CAAC,KAAK,KAAK,KAAK,EAAE,CAAC,CAAC;SAC5C;QAED,YAAY,CAAC,SAAS,GAAG,SAAS,SAAS,CACzC,UAA8B;YAE9B,MAAM,WAAW,GAAG,cAAc,CAAC,UAAU,CAAC,CAAC;YAC/C,OAAO;gBACL,WAAW,EAAE,CAAC;aACf,CAAC;SACH,CAAC;QAEF,OAAO,CAAC,YAAY,EAAE,UAAU,EAAE,SAAS,CAAC,CAAC;KAC9C,CAAC;AACJ,CAAC;SAEe,YAAY,CAC1B,YAAoC,EACpC,MAA0D;;IAE1D,MAAM,OAAO,GAAG,oBAAoB,CAAC,YAAY,CAAC,CAAC;IACnD,MAAM,aAAa,IAAI,MAAM,CAAC,aAAa,GAAG,MAAM,CAAC,aAAa;UAC9D,UAAU,CACR,iBAAiB,CACf,UAAU,CAAC,MAAM,CAAC,aAAqB,CAAC,EACxC,MAAM,CAAC,SAAS,CACjB,CACF;UACA,EAAW,CAAC,CAAC;IAClB,MAAM,cAAc,GAAG,cAAc,CAAC,aAAa,CAAC,aAAa,CAAC,EAAE,KAAK,CAAC,CAAC;IAC3E,MAAM,OAAO,GAAG,YAAY,CAAC,cAAc,CAAC,CAAC;IAE7C,MAAM,eAAe,GAAG,YAAY,CAAC,CAAC,CAAC,CAAC;IACxC,MAAM,CAAC,YAAY,EAAE,iBAAiB,EAAE,gBAAgB,CAAC,GAAG,OAAO,CACjE,CAAC,OAAO,EAAE,eAAe,CAAC,EAC1B,CAAC,CAAC,QAAQ,EAAE,gBAAgB,CAAC;QAC3B,MAAM,SAAS,GAAG,QAAQ,CAAC,QAAe,EAAE,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;QACxD,OAAO,SAAS,IAAI,gBAAgB,IAAI,CAAC,CAAC;KAC3C,EACD,KAAK,CACN,CAAC;;;IAIF,OAAO,YAAY,CAAC,GAAG,CAAC;IACxB,OAAO,YAAY,CAAC,MAAM,CAAC;IAE3B,SAAS,qBAAqB,CAC5B,KAAkC;QAElC,IAAI,gBAAkD,CAAC;QACvD,OAAO,eAAe,kBAAkB,CACtC,KAAW,EACX,KAAmB,EACnB,WAAmE,EACnE,QAAQ,GAAG,KAAK;YAEhB,IAAI,CAAC,WAAW,IAAI,CAAC,KAAK;gBAAE,OAAO;YACnC,IAAI,OAAO,GACT,KAAK,IAAI,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,MAAM,GAAG,CAAC;kBAClC,KAAK;kBACJ,OAAO,CAAC,KAAK,EAAE,EAAE,CAAkB,CAAC;;;YAI3C,MAAM,UAAU,GAAG,0BAA0B,CAAC,QAAQ,CAAC,CAAC;;;;YAKxD,IAAI,EAAC,gBAAgB,aAAhB,gBAAgB,uBAAhB,gBAAgB,CAAE,MAAM,CAAC,QAAQ,CAAA,IAAI,QAAQ,EAAE;gBAClD,gBAAgB,aAAhB,gBAAgB,uBAAhB,gBAAgB,CAAE,KAAK,EAAE,CAAC;gBAC1B,gBAAgB,GAAG,UAAU,CAAC;aAC/B;;;YAID,IAAI,gBAAgB,CAAC,MAAM,CAAC,QAAQ,IAAI,CAAC,QAAQ;gBAAE,OAAO;YAC1D,eAAe,CAAC,MAAM,CAAC,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC;YACrC,MAAM,OAAO,GAAG,cAAc,CAAC,KAAK,EAAE,WAAW,CAAC,CAAC;YACnD,OAAO,CAAC,OAAO,CAAC,OAAO,OAAY;gBACjC,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC;gBAC7B,IAAI,UAAU,CAAC,MAAM,CAAC,OAAO;oBAAE,OAAO;gBACtC,OAAO,GAAG,WAAW,CAAC,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC,CAAC;gBACzC,KAAK,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;aACpB,CAAC,CAAC;YACH,MAAM,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;YAC3B,gBAAgB,GAAG,SAAS,CAAC;YAC7B,eAAe,CAAC,MAAM,CAAC,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC;YACrC,OAAO,OAAO,CAAC;SAChB,CAAC;KACH;IAED,IAAI,WAAW,GAAG,OAAO,CAAC,cAAc,EAAE,EAAE,CAAiB,CAAC;IAC9D,MAAM,IAAI,GAAG,YAAY,CAAC,aAAa,CAAC,CAAC;IAEzC,MAAM,aAAa,GAAG,OAAO,CAAC,cAAc,EAAE,EAAE,CAAiB,CAAC;IAClE,MAAM,eAAe,GAAG,YAAY,CAClC,aAAa,CAC4B,CAAC;IAC5C,MAAM,eAAe,GAAG,YAAY,CAClC,UAAU,CAAC,aAAa,CAAC,CACgB,CAAC;IAC5C,MAAM,CAAC,MAAM,EAAE,WAAW,EAAE,UAAU,CAAC,GAAG,OAAO,CAC/C;QACE,eAAyC;QACzC,eAAyC;KAC1C,EACD,WAAW,EACX,UAAU,CAAC,aAAa,CAAC,CAC1B,CAAC;IAEF,MAAM,eAAe,GAAG,OAAO,CAAC,cAAc,EAAE,EAAE,CAAiB,CAAC;IACpE,MAAM,iBAAiB,GAAG,YAAY,CACpC,eAAe,CAC0B,CAAC;IAC5C,MAAM,iBAAiB,GAAG,YAAY,CACpC,UAAU,CAAC,eAAe,CAAC,CACc,CAAC;IAC5C,MAAM,CAAC,QAAQ,EAAE,aAAa,EAAE,YAAY,CAAC,GAAG,OAAO,CACrD;QACE,iBAA2C;QAC3C,iBAA2C;KAC5C,EACD,WAAW,EACX,UAAU,CAAC,eAAe,CAAC,CAC5B,CAAC;IAEF,MAAM,CAAC,cAAc,EAAE,mBAAmB,EAAE,kBAAkB,CAAC,GAAG,OAAO,CACvE,CAAC,MAAgC,EAAE,OAAkC,CAAC,EACtE,YAAY,EACZ,UAAU,CAAC,aAAa,CAAC,CAC1B,CAAC;IAEF,MAAM,CACJ,gBAAgB,EAChB,qBAAqB,EACrB,oBAAoB,EACrB,GAAG,OAAO,CACT,CAAC,QAAkC,EAAE,OAAkC,CAAC,EACxE,cAAc,EACd,UAAU,CAAC,eAAe,CAAC,CAC5B,CAAC;;;;IAKF,IAAI,WAAW,GAAG,KAAK,CAAC;IACxB,MAAM,CAAC,OAAO,EAAE,YAAY,EAAE,WAAW,CAAC,GAAG,OAAO,CAClD,MAAM,EACN,CAAC,CAAC,OAAO,CAAC;;QACR,IAAI,CAAC,WAAW,EAAE;YAChB,WAAW,GAAG,IAAI,CAAC;YACnB,OAAO,CAAC,MAAM,CAAC,QAAQ,IAAI,EAAC,MAAA,MAAM,CAAC,SAAS,0CAAE,QAAQ,CAAA,CAAC;SACxD;aAAM;YACL,OAAO,CAAC,QAAQ,CAAC,OAAO,EAAE,CAAC,KAAK,KAC9B,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,GAAG,KAAK,CAAC,MAAM,IAAI,CAAC,GAAG,CAAC,CAAC,KAAK,CACnD,CAAC;SACH;KACF,EACD,CAAC,MAAM,CAAC,QAAQ,IAAI,EAAC,MAAA,MAAM,CAAC,SAAS,0CAAE,QAAQ,CAAA,CAChD,CAAC;IAEF,OAAO,OAAO,CAAC,GAAG,CAAC;IACnB,OAAO,OAAO,CAAC,MAAM,CAAC;IAEtB,MAAM,YAAY,GAAG,YAAY,CAAC,KAAK,CAAC,CAAC;IAEzC,MAAM,OAAO,GAAG,YAAY,CAAC,KAAK,CAAC,CAAC;IAEpC,MAAM,UAAU,GAAG,YAAY,CAAgB,IAAI,CAAC,CAAC;IAErD,MAAM,cAAc,GAAG,qBAAqB,CAAC,eAAe,CAAC,CAAC;IAC9D,MAAM,gBAAgB,GAAG,qBAAqB,CAAC,iBAAiB,CAAC,CAAC;IAClE,MAAM,uBAAuB,GAAG,qBAAqB,CAAC,eAAe,CAAC,CAAC;IACvE,MAAM,yBAAyB,GAAG,qBAAqB,CAAC,iBAAiB,CAAC,CAAC;IAC3E,MAAM,wBAAwB,GAAG,QAAQ,CACvC,uBAAuB,EACvB,MAAA,MAAA,MAAA,MAAM,CAAC,SAAS,0CAAE,eAAe,mCAAI,MAAA,MAAM,CAAC,SAAS,0CAAE,OAAO,mCAAI,GAAG,CACtE,CAAC;IACF,MAAM,0BAA0B,GAAG,QAAQ,CACzC,yBAAyB,EACzB,MAAA,MAAA,MAAA,MAAM,CAAC,SAAS,0CAAE,WAAW,mCAAI,MAAA,MAAM,CAAC,SAAS,0CAAE,OAAO,mCAAI,GAAG,CAClE,CAAC;IAEF,eAAe,uBAAuB,CACpC,IAAwB,EACxB,WAAmE;;QAEnE,MAAM,KAAK,GAAG,aAAa,CAAC,IAAI,CAAC,CAAC;QAClC,MAAM,MAAM,GAAG,cAAc,CAC3B,KAAK,EACL,WAAW,EACX,WAAW,aAAX,WAAW,cAAX,WAAW,GAAI,MAAM,CAAC,QAAQ,EAC9B,IAAI,CACL,CAAC;QACF,IAAI,WAAW;YAAE,OAAO,MAAM,CAAC;QAC/B,MAAM,eAAe,GAAG,uBAAuB,CAC7C,KAAK,EACL,WAAW,EACX,MAAA,MAAM,CAAC,SAAS,0CAAE,QAAQ,EAC1B,IAAI,CACL,CAAC;QACF,OAAO,WAAW,CAChB,MAAM,OAAO,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,eAAe,CAAC,CAAC,CAC7C,CAAC;KACH;IAED,eAAe,yBAAyB,CACtC,IAAwB,EACxB,OAA+D;;QAE/D,MAAM,KAAK,GAAG,aAAa,CAAC,IAAI,CAAC,CAAC;QAClC,MAAM,QAAQ,GAAG,gBAAgB,CAC/B,KAAK,EACL,WAAW,EACX,OAAO,aAAP,OAAO,cAAP,OAAO,GAAI,MAAM,CAAC,IAAI,EACtB,IAAI,CACL,CAAC;QACF,IAAI,OAAO;YAAE,OAAO,QAAQ,CAAC;QAC7B,MAAM,iBAAiB,GAAG,yBAAyB,CACjD,KAAK,EACL,WAAW,EACX,MAAA,MAAM,CAAC,SAAS,0CAAE,IAAI,EACtB,IAAI,CACL,CAAC;QACF,OAAO,WAAW,CAChB,MAAM,OAAO,CAAC,GAAG,CAAC,CAAC,QAAQ,EAAE,iBAAiB,CAAC,CAAC,CACjD,CAAC;KACH;IAED,IAAI,WAAW,GAAG,aAAa,CAAC;IAChC,IAAI,aAAa,GAAG,eAAe,CAAC;IACpC,SAAS,KAAK;QACZ,MAAM,gBAAgB,GAAG,IAAI,CAAC,SAAS,CAAC,CAAC,UAAU;;YACjD,MAAM,KAAK,GAAG,aAAa,CAAC,UAAU,CAAC,CAAC;YACxC,cAAc,CAAC,KAAK,EAAE,WAAW,EAAE,MAAM,CAAC,QAAQ,CAAC,CAAC;YACpD,gBAAgB,CAAC,KAAK,EAAE,WAAW,EAAE,MAAM,CAAC,IAAI,CAAC,CAAC;YAClD,wBAAwB,CAAC,KAAK,EAAE,WAAW,EAAE,MAAA,MAAM,CAAC,SAAS,0CAAE,QAAQ,CAAC,CAAC;YACzE,0BAA0B,CAAC,KAAK,EAAE,WAAW,EAAE,MAAA,MAAM,CAAC,SAAS,0CAAE,IAAI,CAAC,CAAC;SACxE,CAAC,CAAC;QAEH,MAAM,kBAAkB,GAAG,OAAO,CAAC,SAAS,CAAC,CAAC,QAAQ;YACpD,WAAW,GAAG,OAAO,CAAC,QAAQ,EAAE,EAAE,CAAiB,CAAC;SACrD,CAAC,CAAC;QACH,MAAM,iBAAiB,GAAG,MAAM,CAAC,SAAS,CAAC,CAAC,OAAO;YACjD,WAAW,GAAG,OAAO,CAAC;SACvB,CAAC,CAAC;QACH,MAAM,mBAAmB,GAAG,QAAQ,CAAC,SAAS,CAAC,CAAC,SAAS;YACvD,aAAa,GAAG,SAAS,CAAC;SAC3B,CAAC,CAAC;QAEH,WAAW,EAAE,CAAC;QACd,YAAY,EAAE,CAAC;QACf,aAAa,EAAE,CAAC;QAChB,mBAAmB,EAAE,CAAC;QACtB,qBAAqB,EAAE,CAAC;QACxB,iBAAiB,EAAE,CAAC;QAEpB,SAAS,OAAO;YACd,gBAAgB,EAAE,CAAC;YACnB,kBAAkB,EAAE,CAAC;YACrB,UAAU,EAAE,CAAC;YACb,YAAY,EAAE,CAAC;YACf,oBAAoB,EAAE,CAAC;YACvB,WAAW,EAAE,CAAC;YACd,gBAAgB,EAAE,CAAC;YACnB,kBAAkB,EAAE,CAAC;YACrB,iBAAiB,EAAE,CAAC;YACpB,mBAAmB,EAAE,CAAC;SACvB;QACD,OAAO,OAAO,CAAC;KAChB;IAED,SAAS,mBAAmB,CAC1B,OAAwD;QAExD,eAAe,CAAC,GAAG,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC,CAAC;QAC1C,eAAe,CAAC,GAAG,CAAC,EAA4B,CAAC,CAAC;KACnD;IAED,SAAS,qBAAqB,CAC5B,OAAwD;QAExD,iBAAiB,CAAC,GAAG,CAAC,OAAO,CAAC,aAAa,CAAC,CAAC,CAAC;QAC9C,iBAAiB,CAAC,GAAG,CAAC,EAA4B,CAAC,CAAC;KACrD;IAED,SAAS,kBAAkB,CAAC,KAA6B;QACvD,mBAAmB,CAAC,MAAM,KAAK,CAAC,CAAC;KAClC;IAED,SAAS,oBAAoB,CAAC,KAA6B;QACzD,qBAAqB,CAAC,MAAM,KAAK,CAAC,CAAC;KACpC;IAED,cAAc,CAAC,GAAG,GAAG,kBAAkB,CAAC;IACvC,cAA8C,CAAC,MAAM,GAAG,mBAAmB,CAAC;IAC7E,gBAAgB,CAAC,GAAG,GAAG,oBAAoB,CAAC;IAC3C,gBAAgD,CAAC,MAAM,GAAG,qBAAqB,CAAC;IAEjF,OAAO;QACL,IAAI,EAAE,IAAsC;QAC5C,MAAM,EAAE,cAAwD;QAChE,QAAQ,EAAE,gBAA0D;QACpE,OAAO;QACP,OAAO;QACP,YAAY;QACZ,OAAO;QACP,YAAY;QACZ,UAAU;QACV,cAAc,EAAE,uBAAuB;QACvC,gBAAgB,EAAE,yBAAyB;QAC3C,OAAO,EAAE,MAAM,CAAC,iBAAiB,GAAG,MAAM,SAAS,GAAG,KAAK,EAAE;QAC7D,KAAK;KACN,CAAC;AACJ;;;;"}